# 理解 IO 多路复用

> 作者：[戊子仲秋](https://github.com/wuzizhongqiu)，[编程导航星球](https://wx.zsxq.com/dweb2/index/group/51122858222824) 编号 20000

## I/O 多路复用是什么？

- I/O 多路复用是用户程序通过复用一个线程来服务多个 I/O 事件的机制，我们也可以将他说成是一个线程服务多个文件描述符 fd，而 I/O 多路复用是在操作系统层面实现提供的，举个例子：Linux 平台下常见的 I/O 多路复用有：select、poll、epoll

## 刚刚提到文件描述符 fd，那 fd 到底是什么？有什么作用？

- fd 是文件描述符，用来表示一个文件，我们可以通过 fd 找到对应的文件并对他进行读写操作
- 可以说 fd 是一个索引值，能帮助我们索引到对应的 socket 文件或是已经打开的磁盘文件

## 那 socket 又是什么？

- socket 文件代表操作系统内核中的一段 buffer，数据从客户端传输过来后，通过网络协议栈的处理，socket 文件中保存的就是客户端传来的数据，读取 socket 文件就能获取到客户端相关的数据，形象的说，socket 就像是一个能够进行双向数据传输的管道
- 举个例子，当客户端和服务端建立通信，双方都存在一个 socket 文件，socket 建立内核 buffer 和用户程序的通道完成数据的传输

## 那数据到达我们的服务器，被用户程序读取到，中间的过程具体是什么样的？

看图：

![](https://pic.yupi.icu/5563/202312241537948.png)

- 数据在客户端进行层层包装之后，传输到我们的服务器，网卡通过 DMA 技术将收到的 frame 写到操作系统的内核，接着触发 CPU 中断，让操作系统不断从 buffer 中取出数据交给协议栈处理，数据在经过协议栈处理后进入 socket 文件，所以 socket 文件中就存在了客户端相关的数据，我们就可以对这些数据进行读写操作了

## 什么是 DMA 技术？

- DMA（Direct Memory Access）用于在外设与存储器之间以及存储器与存储器之间提供高速数据传输，可以在无需任何 CPU 操作的情况下通过 DMA 快速移动数据，这样节省的 CPU 资源可供其它操作使用。

## 什么是 frame?

- 一个 http 报文最终会传输到数据链路层，而链路层（以太网）的最基本单位是 frame，也叫做以太帧

## 问题来了，那为什么需要 I/O 多路复用？

- 刚刚我们聊到，客户端的数据传输过来，进入了 socket 文件中，当他们发生事件的时候，用户程序需要创建线程进行处理
  - 一般 fd 对应两种事件
    - 是否可以写（缓冲区满了，可能写不下，注册事件，等到可以写了，通知我）
    - 是否可以读（缓冲区有数据的时候，就可以读了）
  - 而网卡能够知道 fd 是否有时间发生，并通知操作系统，但用户程序不知道
- I/O 多路复用就是解决这一个问题，让线程快速得知 fd 是否有事件发生（是否可以读，是否可以写）
  - 一个线程能并发的服务多个 I/O 事件，这就是 I/O 多路复用的含义

## 总结：如何理解 I/O 多路复用

- 如果不使用 I/O 多路复用，在并发处理多个客户端的 I/O 事件的的场景下，服务端需要通过创建子进程或者线程的方式，给每一个连接的 I/O 事件分配一个线程来处理，随着客户端越来越多，服务端需要创建更多的线程，系统的开销太大，效率太低
- 我们需要一种机制，让一个线程能并发的服务多个 I/O 事件，这就是 I/O 多路复用的含义
- 所以操作系统设立了多种 I/O 多路复用的机制来解决这个问题，线程可以通过 select、poll、epoll 这类 I/O 多路复用系统调用接口从内核中通过网卡获取有事件发生的 socket 集合，然后就可以通过遍历这个集合，对每一个 I/O 事件进行处理，这样就实现了一个线程并发的处理多个 I/O 事件，大大提高了效率

这就是为什么我们需要 I/O 多路复用的技术