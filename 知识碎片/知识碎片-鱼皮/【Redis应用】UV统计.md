# 【Redis应用】UV统计

> 作者：[.](https://blog.csdn.net/m0_66570338)，[编程导航星球](https://wx.zsxq.com/dweb2/index/group/51122858222824) 编号 6872

> Redis实现UV统计

## 一.引入

首先我们要搞懂两个概念：

- `UV`：全称`Unique Visitor`，也叫**独立访客量**，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。
- `PV`：全称`Page View`，也叫**页面访问量或点击量**，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。

通常来说PV会比UV大很多，所以当我们要去衡量一个网站的情况，我们需要结合多个值一起来分析，通过UV我们可以得知网站的访客量，通过PV我们可以得知页面的访问量，而通过pv与uv的比值我们可以得知网站的用户粘度。

UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖，那怎么处理呢？

## 二.HyperLogLog使用

`Hyperloglog(HLL)`是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。相关算法原理可以参考：[点击跳转](https://juejin.cn/post/6844903785744056333#heading-0)。 Redis中的HLL是基于string结构实现的，单个HLL的内存**永远小于16kb**，**内存占用低**的令人发指！作为代价，其测量结果是概率性的，**有小于0.81％的误差**。不过对于UV统计来说，这完全可以忽略。

**它对应的命令有三个：** 

![](https://pic.yupi.icu/5563/202311171851679.png)

 当我们使用`PFADD`命令添加元素时他会自动帮助我们去除重复元素，只统计不同的元素个数。

## 三.模拟实现UV统计

由于我们没有那么多的测试用户，所以我们选择利用单元测试模拟100万次用户访问量。

测试思路：我们直接利用单元测试，向HyperLogLog中添加100万条数据，看看内存占用和统计效果如何

```java
   // 准备数组，装填用户数据
        String[] users = new String[1000];
        // 数组角标
        int index = 0;
        for (int i = 0; i < 1000000; i++) {
            // 赋值
            users[index++] = "user_" + i;
            // 每1000条发送以此
            if (i % 1000 == 0) {
                index = 0;
                redisTemplate.opsForHyperLogLog().add("test", users);
            }
        }
        // 统计数量
        Long size = redisTemplate.opsForHyperLogLog().size("test");
        System.out.println("size=" + size);
```

经过测试：我们可以发现它确实可以帮助我们统计UV并且内存占用极小，但确实存在一定的误差，但是误差是在允许范围内的。

![](https://pic.yupi.icu/5563/202311171851038.png)